<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>College Basketball Rankings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PWG43QNM3P"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-PWG43QNM3P');
</script>

<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f6f8; color:#111; }
  .page { max-width:1100px; margin:0 auto; padding:20px; }
  .top-nav { margin-bottom:20px; }
  .top-nav a { text-decoration:none; color:#111; font-weight:bold; font-size:0.9rem; }
  .top-nav a:hover { text-decoration:underline; }
  h1 { text-align:center; margin-bottom:10px; }
  .subtitle { text-align:center; margin-bottom:20px; color:#555; }
  .toggle-buttons { text-align:center; margin-bottom:20px; }
  .toggle-buttons button {
    padding:8px 16px; margin:0 5px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; background:#ddd; transition:0.2s;
  }
  .toggle-buttons button.active { background:#111; color:#fff; }
  .toggle-buttons button:hover { background:#aaa; color:#fff; }

  table { border-collapse:collapse; width:100%; margin-top:10px; background:#fff; border-radius:6px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
  th, td { padding:8px 10px; border:1px solid #ccc; text-align:left; }
  th { background-color:#f2f2f2; cursor:pointer; user-select:none; }
  th.sort-asc::after { content:" ▲"; }
  th.sort-desc::after { content:" ▼"; }
  select { padding:6px 10px; margin-bottom:15px; border-radius:5px; border:1px solid #ccc; }

  /* Highlight classes */
  .top10 { background: #e0f7fa; }        /* Elo Top 10 */
  .top3 { background: #e8f5e9; }         /* Conference Elo Top 3 */
  .conf-leader { background: #fff3e0; }  /* Conference Standings Leader */
  .win { background: #d0f0c0; }          /* Game Predictor winner */
  .lose { background: #f8d7da; }         /* Game Predictor loser */
  .auto-bid { background: #d4f0d4; }     /* Projected bracket auto bid */
  .at-large { background: #ffe4b2; }     /* Projected bracket at-large */

  /* Font coloring for record */
  .record-win { color: green; font-weight:bold; }
  .record-loss { color: red; font-weight:bold; }

  /* Graph containers */
  #graphs-container { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px; }
  .graph { flex:1; min-width:300px; }
  canvas { background:#fff; border-radius:6px; padding:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }

  /* Hypothetical matchup */
  #matchup-container { margin-bottom:20px; text-align:center; }
  #team-selects select { padding:6px 10px; margin:0 5px; border-radius:5px; border:1px solid #ccc; }
  #predicted-winner { font-weight:bold; margin-top:10px; font-size:1.1rem; }
</style>
</head>

<body>
<div class="page">

  <div class="top-nav">
    <a href="index.html">← Back to College Basketball</a>
  </div>

  <h1 id="title">College Basketball Rankings</h1>
  <div class="subtitle">Elo-based rankings by season (2003–2026)</div>

  <!-- Hypothetical matchup -->
  <div id="matchup-container">
    <div id="team-selects">
      <select id="team1"><option>Loading...</option></select>
      vs
      <select id="team2"><option>Loading...</option></select>
      <button id="predict-btn">Predict Winner</button>
    </div>
    <div id="predicted-winner"></div>
  </div>

  <!-- Graphs -->
  <div id="graphs-container">
    <div class="graph">
      <canvas id="elo-bar-chart"></canvas>
    </div>
    <div class="graph">
      <canvas id="predictor-scatter"></canvas>
    </div>
  </div>

  <div class="toggle-buttons" id="toggle-buttons" style="display:none;">
    <button id="show-elo" class="active">Elo Rankings</button>
    <button id="show-projected">Projected Seeding</button>
    <button id="show-conf-elo">Conference Elo</button>
    <button id="show-conf-standings">Conference Standings (2026)</button>
    <button id="show-game-predictor">Game Predictor (2026)</button>
    <button id="show-resume">Resume (2026)</button>
  </div>

  <!-- Elo Rankings -->
  <div id="elo-container">
    <table id="elo-table"><thead><tr></tr></thead><tbody></tbody></table>
  </div>

  <!-- Projected Bracket -->
  <div id="projected-container" style="display:none;">
    <table id="projected-table"><thead><tr></tr></thead><tbody></tbody></table>
  </div>

  <!-- Conference Elo -->
  <div id="conf-elo-container" style="display:none;">
    <table id="conf-elo-table"><thead><tr></tr></thead><tbody></tbody></table>
  </div>

  <!-- Conference Standings Dropdown (2026 only) -->
  <div id="conf-standings-container" style="display:none;">
    <select id="conf-dropdown"></select>
    <table id="conf-standings-table"><thead><tr></tr></thead><tbody></tbody></table>
  </div>

  <!-- Game Predictor (2026 only) -->
  <div id="game-predictor-container" style="display:none;">
    <table id="game-predictor-table"><thead><tr></tr></thead><tbody></tbody></table>
  </div>

  <!-- Resume Tab (2026 only) -->
  <div id="resume-container" style="display:none;">
    <table id="resume-table"><thead><tr></tr></thead><tbody></tbody></table>
  </div>

</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const params = new URLSearchParams(window.location.search);
const year = params.get("year") || "2026";
document.getElementById("title").textContent = `College Basketball ${year} Rankings`;

const eloCsv = `data/CBB_Elo_${year}.csv`;
const projectedCsv = `data/projected_bracket${year}.csv`;
const confEloCsv = `data/CBB_Conference_Elo_${year}.csv`;

const eloContainer = document.getElementById("elo-container");
const projectedContainer = document.getElementById("projected-container");
const confEloContainer = document.getElementById("conf-elo-container");
const confStandingsContainer = document.getElementById("conf-standings-container");
const gamePredictorContainer = document.getElementById("game-predictor-container");
const resumeContainer = document.getElementById("resume-container");
const toggleButtons = document.getElementById("toggle-buttons");

const showEloBtn = document.getElementById("show-elo");
const showProjectedBtn = document.getElementById("show-projected");
const showConfEloBtn = document.getElementById("show-conf-elo");
const showConfStandingsBtn = document.getElementById("show-conf-standings");
const showGamePredictorBtn = document.getElementById("show-game-predictor");
const showResumeBtn = document.getElementById("show-resume");

let sortState = {};
let eloDataAll = [], predictorDataAll = [];

// --- Fetch CSV ---
function fetchCSV(path, callback, errorMsg){
  fetch(path).then(r=>r.ok?r.text():Promise.reject()).then(csv=>{
    const rows = csv.trim().split("\n").map(r=>r.split(","));
    callback(rows);
  }).catch(()=>console.warn(errorMsg));
}

// --- Populate Wins/Loss coloring ---
function colorRecord(td){
  const val = td.textContent;
  if(/\d+-\d+/.test(val)){
    const [w,l] = val.split("-").map(Number);
    td.innerHTML = `<span class="record-win">${w}</span>-<span class="record-loss">${l}</span>`;
  }
}

// --- Generic table render ---
function renderTable(headers,data,theadRow,tbody,highlightTop=0,highlightCol=-1,highlightClass=""){
  theadRow.innerHTML=""; tbody.innerHTML="";
  headers.forEach((h,i)=>{
    const th = document.createElement("th");
    th.textContent = h;
    th.addEventListener("click",()=>sortTable(i,data,tbody,th,highlightTop,highlightCol,highlightClass));
    theadRow.appendChild(th);
  });
  populateRows(data, tbody, highlightTop, highlightCol, highlightClass);
}

function populateRows(data, tbody, highlightTop, highlightCol, highlightClass){
  tbody.innerHTML="";
  data.forEach((row,index)=>{
    const tr=document.createElement("tr");
    row.forEach((cell,i)=>{
      const td=document.createElement("td");
      td.textContent=cell;
      if(/\d+-\d+/.test(cell)){
        colorRecord(td);
      }
      if(highlightTop>0 && index<highlightTop && highlightCol===i){
        td.classList.add(highlightClass);
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function sortTable(colIndex, data, tbody, th, highlightTop, highlightCol, highlightClass){
  const headers = th.parentElement.querySelectorAll("th");
  headers.forEach(h=>h.classList.remove("sort-asc","sort-desc"));
  const ascending = sortState[colIndex] !== "asc";
  sortState = { [colIndex]: ascending?"asc":"desc" };
  th.classList.add(ascending?"sort-asc":"sort-desc");
  data.sort((a,b)=>{
    const A=parseFloat(a[colIndex]), B=parseFloat(b[colIndex]);
    if(!isNaN(A)&&!isNaN(B)) return ascending?A-B:B-A;
    return ascending?a[colIndex].toString().localeCompare(b[colIndex].toString()):b[colIndex].toString().localeCompare(a[colIndex].toString());
  });
  populateRows(data, tbody, highlightTop, highlightCol, highlightClass);
}

// --- Projected Bracket ---
function renderProjectedBracket(headers,data,theadRow,tbody){
  theadRow.innerHTML=""; tbody.innerHTML="";
  const autoBidCol = headers.findIndex(h=>h.toLowerCase().includes("auto_bid"));
  headers.forEach((h,i)=>{
    const th = document.createElement("th");
    th.textContent = h;
    th.addEventListener("click",()=>sortTable(i,data,tbody,th,0,autoBidCol,"auto-bid"));
    theadRow.appendChild(th);
  });
  data.forEach(row=>{
    const tr=document.createElement("tr");
    row.forEach((cell,i)=>{
      const td=document.createElement("td");
      td.textContent = cell;
      if(i===autoBidCol){
        td.classList.add(cell.toLowerCase()==="true"?"auto-bid":"at-large");
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

// --- Load Elo CSV ---
fetchCSV(eloCsv, rows=>{
  eloDataAll = rows.slice(1); // for graphs / matchups
  renderTable(rows[0], eloDataAll, document.querySelector("#elo-table thead tr"), document.querySelector("#elo-table tbody"), 10, 0, "top10");
  toggleButtons.style.display="block";
  populateTeamDropdowns(eloDataAll);
  renderEloGraph(eloDataAll);
}, `Elo CSV not found for ${year}`);

// --- Load Predictor CSV ---
fetchCSV("data/CBB_Elo_Future_Game_Predictions.csv", rows=>{
  predictorDataAll = rows.slice(1);
  renderPredictorScatter(rows.slice(1));
}, "Game Predictor CSV not found");

// --- Populate team dropdowns ---
function populateTeamDropdowns(data){
  const t1 = document.getElementById("team1");
  const t2 = document.getElementById("team2");
  t1.innerHTML=""; t2.innerHTML="";
  const teams = data.map(r=>r[0]).sort();
  teams.forEach(team=>{
    const opt1 = document.createElement("option"); opt1.value=team; opt1.textContent=team;
    const opt2 = document.createElement("option"); opt2.value=team; opt2.textContent=team;
    t1.appendChild(opt1); t2.appendChild(opt2);
  });
}

// --- Predict matchup ---
document.getElementById("predict-btn").onclick = ()=>{
  const team1 = document.getElementById("team1").value;
  const team2 = document.getElementById("team2").value;
  const match = predictorDataAll.find(r=>
    (r[0]===team1 && r[1]===team2) || (r[0]===team2 && r[1]===team1))
  );
  if(match){
    const winner = match[2]; // assumes CSV format: team1, team2, predicted_winner
    document.getElementById("predicted-winner").textContent = `Predicted Winner: ${winner}`;
  } else {
    document.getElementById("predicted-winner").textContent = "No prediction found for selected matchup";
  }
};

// --- Elo Graph ---
function renderEloGraph(data){
  const ctx = document.getElementById("elo-bar-chart").getContext("2d");
  const top10 = data.slice(0,10);
  new Chart(ctx,{
    type:'bar',
    data:{
      labels: top10.map(r=>r[0]),
      datasets:[{
        label:'Elo Rating',
        data: top10.map(r=>Number(r[1])),
        backgroundColor:'#2196f3'
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:false}}
    }
  });
}

// --- Predictor Scatterplot ---
function renderPredictorScatter(data){
  const ctx = document.getElementById("predictor-scatter").getContext("2d");
  const scatterData = data.map(r=>({x:Number(r[3]), y:Number(r[4]), label:`${r[0]} vs ${r[1]}`})); // assuming columns: team1, team2, winner, high_elo, low_elo
  new Chart(ctx,{
    type:'scatter',
    data:{
      datasets:[{
        label:'Higher vs Lower Seed Elo',
        data:scatterData,
        backgroundColor:'purple'
      }]
    },
    options:{
      responsive:true,
      plugins:{
        tooltip:{
          callbacks:{
            label: ctx => ctx.raw.label + ` (High:${ctx.raw.x}, Low:${ctx.raw.y})`
          }
        }
      },
      scales:{x:{title:{display:true,text:"Higher Seed Elo"}},y:{title:{display:true,text:"Lower Seed Elo"}}}
    }
  });
}

// --- Toggle tabs ---
function toggleTab(showContainer, activeBtn){
  [eloContainer, projectedContainer, confEloContainer, confStandingsContainer, gamePredictorContainer, resumeContainer].forEach(c=>c.style.display="none");
  [showEloBtn, showProjectedBtn, showConfEloBtn, showConfStandingsBtn, showGamePredictorBtn, showResumeBtn].forEach(b=>b.classList.remove("active"));
  showContainer.style.display="block"; activeBtn.classList.add("active");
}

showEloBtn.onclick=()=>toggleTab(eloContainer, showEloBtn);
showProjectedBtn.onclick=()=>toggleTab(projectedContainer, showProjectedBtn);
showConfEloBtn.onclick=()=>toggleTab(confEloContainer, showConfEloBtn);
showConfStandingsBtn.onclick=()=>toggleTab(confStandingsContainer, showConfStandingsBtn);
showGamePredictorBtn.onclick=()=>toggleTab(gamePredictorContainer, showGamePredictorBtn);
showResumeBtn.onclick=()=>toggleTab(resumeContainer, showResumeBtn);
</script>
</body>
</html>

